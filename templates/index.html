<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NEOC AI Based Early Warning System</title>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- External Stylesheets -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

  <!-- Neomorphic Design System -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/neomorphic.css') }}">


  <style>
    /* Colors */
    @import url('https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,200..900;1,200..900&display=swap');

    :root {
      --color-bg-dark: #183B4E;
      --color-bg-lightgray: #cccccc;
      --color-border: #224d64;
      --color-text: #F3F3E0;
      --color-accent: #b7e806;
      --color-danger: #ff4d4d;
      --font-main: "Helvetica Neue", sans-serif;
      --glass-bg: rgba(255, 255, 255, 0.08);
      --glass-border: rgba(255, 255, 255, 0.15);
      --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
    }

    body {
      background-color: var(--color-bg-dark);
      font-family: var(--font-main);
      margin: 0;
      padding: 0;
      min-height: 100vh;
      overflow: hidden;
    }

    .dashboard-container {
      display: grid;
      grid-template-columns: 320px 1fr 487px;
      height: calc(100vh - 70px - 25px);
      gap: 0;
    }

    .sidebar-left {
      background: var(--color-bg-dark);
      color: white;
      padding: 20px;
      overflow-y: auto;
      box-shadow: 4px 0 15px rgba(0, 0, 0, 0.3);
      padding-bottom: 40px;
      z-index: 10;
    }

    .logo-container {
      text-align: center;
      margin-bottom: 25px;
      padding-bottom: 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .logo {
      height: 60px;
      margin-bottom: -10px;
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    .logo:hover {
      transform: scale(1.1) rotate(5deg);
    }

    .sidebar-section {
      background: var(--glass-bg);
      backdrop-filter: blur(4px);
      border: 1px solid var(--glass-border);
      padding: 18px;
      border-radius: 12px;
      margin-bottom: 20px;
      box-shadow: var(--glass-shadow);
    }

    .form-label {
      color: rgba(255, 255, 255, 0.9);
      font-weight: 600;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .form-select,
    .form-control {
      background: rgba(255, 255, 255, 0.1) !important;
      border: 1px solid rgba(255, 255, 255, 0.2) !important;
      color: white !important;
      border-radius: 8px;
      padding: 10px;
      transition: all 0.3s ease;
    }

    .form-select:focus,
    .form-control:focus {
      background: rgba(255, 255, 255, 0.15) !important;
      border-color: var(--color-accent) !important;
      box-shadow: 0 0 0 0.25rem rgba(183, 232, 6, 0.25) !important;
    }

    .form-select option {
      background: var(--color-bg-dark);
      color: white;
    }

    .district-filter {
      max-height: 220px;
      overflow-y: auto;
      background: rgba(0, 0, 0, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      padding: 12px;
      margin-top: 10px;
      scrollbar-width: thin;
      scrollbar-color: var(--color-accent) rgba(255, 255, 255, 0.1);
    }

    .btn-sidebar {
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      color: white;
      width: 100%;
      margin-bottom: 10px;
      border-radius: 10px;
      padding: 12px;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .btn-sidebar i {
      font-size: 1.1rem;
      opacity: 0.8;
      transition: transform 0.3s ease;
    }

    .btn-sidebar:hover {
      background: rgba(255, 255, 255, 0.15);
      border-color: var(--color-accent);
      color: var(--color-accent);
      transform: translateY(-3px) scale(1.02);
      box-shadow: 0 8px 20px rgba(183, 232, 6, 0.2);
    }

    .btn-sidebar:hover i {
      transform: scale(1.2);
      opacity: 1;
    }

    .btn-sidebar:active {
      transform: translateY(-1px) scale(0.98);
    }

    .btn-danger-sidebar {
      border-color: rgba(255, 77, 77, 0.3) !important;
    }

    .btn-danger-sidebar:hover {
      border-color: var(--color-danger) !important;
      color: var(--color-danger) !important;
      box-shadow: 0 8px 20px rgba(255, 77, 77, 0.25) !important;
    }

    .map-container {
      background: var(--color-bg-lightgray);
      position: relative;
      height: 100%;
      overflow: hidden;
    }

    .map-content {
      width: 100%;
      height: 100%;
      position: relative;
    }

    .map-content iframe,
    .map-content>div,
    .map-content>div>div {
      height: 100% !important;
      width: 100% !important;
      padding-bottom: 0 !important;
      border: none !important;
    }

    .sidebar-right {
      background: var(--color-border);
      padding: 10px;
      box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
      display: flex;
      flex-direction: column;
      height: 100%;
      overflow: hidden;
    }

    .sidebar-scrollable {
      flex: 1;
      overflow-y: auto;
      min-height: 0;
      display: flex;
      flex-direction: column;
    }

    .alert-header {
      background: var(--color-bg-dark);
      color: white;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 20px;
      text-align: center;
      flex-shrink: 0;
    }

    .alert-header:hover {
      animation: float 1.4s ease-in-out infinite;
    }

    .alert-content {
      background: #183B4E;
      border-left: 4px solid #183B4E;
      padding: 15px;
      border-radius: 8px;
      font-size: 1.2rem;
      flex: 1;
      display: block;
      text-align: left;
      overflow-y: auto;
      line-height: 1.4;
    }

    .alert-content b {
      color: #2c5aa0;
      font-weight: 600;
    }

    .district-alert-header {
      margin: 15px 0 8px 0;
      padding: 8px 12px;
      background: #e8f4fd;
      border-radius: 5px;
      border-left: 4px solid #2c5aa0;
      font-weight: 600;
    }

    .district-alert-header b {
      color: #2c5aa0;
    }

    .district-alert-box:hover,
    .province-summary-header:hover {
      animation: float 1.4s ease-in-out infinite;
      cursor: pointer;
    }

    .province-summary-header {
      margin: 20px 0 10px 0;
      padding: 10px 12px;
      background: #183B4E;
      border-radius: 5px;
      border-left: 4px solid #ffc107;
      font-weight: 600;
    }

    .province-summary-header b {
      color: #856404;
    }

    .alert-line {
      margin: 5px 0;
      padding: 0 12px;
      line-height: 1.4;
    }

    .footer {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: var(--color-bg-dark);
      border-top: 1px solid var(--color-bg-lightgray);
      text-align: center;
      padding: 3px 0;
      font-size: 0.85rem;
      color: var(--color-bg-lightgray);
      z-index: 9999;
    }

    .top-header {
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--color-bg-dark);
      color: white;
      padding: 10px 20px;
      height: 70px;
      position: sticky;
      top: 0;
      z-index: 1000;
    }

    .top-header .logo {
      height: 70px;
      margin-right: auto;
    }

    .top-header .title {
      font-size: 3rem;
      font-weight: 700;
      text-align: center;
      flex-grow: 1;
    }

    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 10000;
    }

    .loading-spinner {
      background: white;
      padding: 20px 40px;
      border-radius: 10px;
      text-align: center;
    }

    .spinner-border {
      width: 3rem;
      height: 3rem;
    }

    .selected-district-header {
      background: #e8f4fd;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 15px;
      border-left: 4px solid #2c5aa0;
    }

    .selected-district-header h6 {
      margin: 0;
      color: #2c5aa0;
      font-weight: 600;
    }

    .selected-district-header small {
      font-size: 0.8rem;
    }

    .district-alert-content {
      padding: 10px 0;
    }

    .alert-message {
      background: white;
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
      line-height: 1.5;
    }

    .selected-district {
      color: #2c5aa0 !important;
      font-weight: bold !important;
    }

    .no-alerts {
      text-align: center;
      padding: 40px 20px;
      color: #666;
      font-style: italic;
    }

    @keyframes float {
      0% {
        transform: translateY(0);
      }

      50% {
        transform: translateY(-8px);
      }

      100% {
        transform: translateY(0);
      }
    }

    @keyframes fadeSlideIn {
      0% {
        opacity: 0;
        transform: translateY(-10px);
      }

      100% {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Navbar Base Design */
    #top-div {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #02174e;
      /* Portal theme */
      padding: 0 32px 0 16px;
      height: 70px;
      width: 100%;
      position: relative;
      z-index: 3000;
      font-weight: 700;
      font-size: 3rem;
    }

    #ndma-logo {
      display: flex;
      align-items: center;
      height: 70px;
      width: auto;
      position: static;
      z-index: 3000;
    }

    #ndma-logo img {
      height: 70px;
      width: auto;
      z-index: 3000;
    }

    #nav-bar {
      display: flex;
      align-items: center;
      margin-left: auto;
      position: static;
      z-index: 9999;
    }

    #hello-text {
      font-family: 'Segoe UI', sans-serif;
      flex: 1;
      text-align: center;
      color: #ffffff;
      font-size: 3rem;
      font-weight: 700;
      letter-spacing: 2px;
      text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.4);
      position: absolute;
      left: 0;
      right: 0;
      margin: auto;
      pointer-events: none;
      z-index: 3000;
    }

    #G-12 {
      display: flex !important;
      align-items: center;
      justify-content: center;
      width: 80px;
      height: 50px;
      background: #ffffff !important;
      color: rgba(3, 129, 3) !important;
      font-size: 2rem !important;
      font-weight: 700 !important;
      border-radius: 3px;
      margin-left: 16px;
      /* text-shadow: 2px 2px 8px rgba(3, 129, 3, 0.5); */
      text-align: center;
      font-family: 'Segoi UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    /* Responsive adjustments */
    @media (max-width: 991.98px) {
      #top-div {
        flex-direction: column;
        align-items: stretch;
        padding: 0 8px;
      }

      #hello-text {
        position: static;
        margin: 8px 0;
      }

      #nav-bar {
        margin-left: 0;
        justify-content: flex-end;
      }
    }
  </style>
</head>

<body>
  <div id="top-div">
    <a href="index.html" class="navbar-brand d-flex align-items-center text-center"></a>
    <div id="ndma-logo">
      <img src="static/NDMA_Pakistan_Logo.png" alt="NDMA Icon">
    </div>
    <div id="hello-text">NEOC AI-Based Early Warning System</div>
    <div id="nav-bar">
      <nav class="navbar navbar-expand-lg navbar-dark py-0">
        <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbarCollapse"
          aria-expanded="false" aria-controls="navbarCollapse">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarCollapse">
          <div class="navbar-nav ms-auto">
            <a class="navbar-brand fs-3 fw-bold" id="G-12" href="#">N-12</a>
          </div>
        </div>
      </nav>
    </div>
  </div>
  </div>
  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="neo-card" style="width: 320px; text-align: center;">
      <div class="neo-spinner mx-auto mb-4"></div>
      <p id="loadingText" style="color: var(--neo-text-primary); font-weight: 500;">Loading...</p>
    </div>
  </div>

  <!-- Mobile Toggle Buttons -->
  <button class="neo-btn neo-btn-accent mobile-toggle mobile-toggle-left" onclick="toggleSidebar('left')"
    aria-label="Toggle filters">
    <i class="fas fa-sliders-h"></i>
  </button>
  <button class="neo-btn neo-btn-accent mobile-toggle mobile-toggle-right" onclick="toggleSidebar('right')"
    aria-label="Toggle alerts">
    <i class="fas fa-bell"></i>
  </button>



  <div class="dashboard-container">
    <!-- Left Sidebar -->
    <div class="sidebar-left">
      <div class="sidebar-section">
        <label class="form-label">Forecast Days</label>
        <select class="form-select mb-3" name="forecast_days" id="forecast_days" data-bs-toggle="tooltip"
          data-bs-placement="right" title="Number of days to forecast weather conditions"
          aria-label="Select forecast duration">
          {% for days in range(1, 8) %}
          <option value="{{ days }}" {% if days==selected_forecast_days %}selected{% endif %}>
            {{ days }} day{% if days > 1 %}s{% endif %}
          </option>
          {% endfor %}
        </select>

        <label class="form-label">Select Region</label>
        <select class="form-select mb-3" name="province" id="province" data-bs-toggle="tooltip"
          data-bs-placement="right" title="Choose a province to view district-level forecasts"
          aria-label="Select province">
          {% for p in provinces %}
          <option value="{{ p }}" {% if p==selected_province %}selected{% endif %}>{{ p }}</option>
          {% endfor %}
        </select>

        <label class="form-label">Filter Districts</label>

        <!-- District Search -->
        <div class="mb-3">
          <input type="text" class="form-control neo-input" id="districtSearch" placeholder="ðŸ” Search districts..."
            oninput="filterDistricts(this.value)" aria-label="Search districts">
        </div>

        <div class="d-grid gap-2 mb-2">
          <button type="button" class="neo-btn  neo-btn-sm" onclick="selectAllDistricts()"
            aria-label="Select all districts">
            <i class="fas fa-check-circle"></i> Select All
          </button>
          <button type="button" class="neo-btn  neo-btn-sm" onclick="deselectAllDistricts()"
            aria-label="Deselect all districts">
            <i class="fas fa-times-circle"></i> Deselect All
          </button>
        </div>

        <div class="district-filter" id="districtFilter">
          {% for district in districts %}
          <div class="form-check d-flex align-items-center gap-2 mb-2">
            <input class="neo-checkbox" type="checkbox" name="districts" value="{{ district }}"
              id="district-{{ loop.index }}" {% if district in selected_districts or selected_districts|length==0
              %}checked{% endif %}>
            <label class="form-check-label" for="district-{{ loop.index }}" style="cursor: pointer;">
              {{ district }}
            </label>
          </div>
          {% endfor %}
        </div>
      </div>

      <div class="d-grid gap-2">
        <button type="button" class="neo-btn neo-btn-accent" onclick="generateForecastAndAlerts()"
          data-bs-toggle="tooltip" data-bs-placement="right"
          title="Generate both weather forecasts and early warning alerts in one step" aria-label="Run full analysis">
          <i class="fas fa-bolt"></i> <span>Run Analysis</span>
        </button>
      </div>

      <div class="mt-4 pt-3" style="border-top: 1px solid rgba(255,255,255,0.1);">
        <label class="form-label mb-2"
          style="font-size: var(--text-xs); color: var(--neo-text-muted); text-transform: uppercase; letter-spacing: 1px;">System
          Tools</label>
        <div class="d-flex gap-2">
          <button type="button" class="neo-btn neo-btn-sm flex-fill" id="blinkingToggle" onclick="toggleAnimation()"
            data-bs-toggle="tooltip" data-bs-placement="top" title="Toggle map highlighting animation">
            <i class="fas fa-eye"></i> <span>Animation</span>
          </button>
          <button type="button" class="neo-btn neo-btn-sm neo-btn-danger flex-fill" onclick="purgeCache()"
            data-bs-toggle="tooltip" data-bs-placement="top" title="Force refresh by clearing data cache">
            <i class="fas fa-trash-alt"></i> <span>Purge Cache</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Center Map -->
    <div class="map-container">
      <div class="map-content">
        {{ map_html | safe }}
      </div>
    </div>

    <!-- Right Sidebar -->
    <div class="sidebar-right">
      <div class="alert-header">
        <h6><i class="fas fa-exclamation-triangle"></i> Alerts for <span id="currentProvince">{{ selected_province
            }}</span></h6>
      </div>
      <div class="sidebar-scrollable">
        <div class="alert-content" id="alertContent">
          <div class="no-alerts">
            <i class="fas fa-info-circle"
              style="font-size: 3rem; color: var(--neo-text-muted); margin-bottom: var(--space-4);"></i>
            <p style="margin: 0; font-size: var(--text-lg); font-weight: 600; color: var(--neo-text-secondary);">No
              Alerts Yet</p>
            <p style="margin-top: var(--space-2); font-size: var(--text-sm); color: var(--neo-text-muted);">Select
              districts from the left sidebar and click <strong>"Generate Alerts"</strong> to view early warnings.</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/typed.js@2.0.12"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Toast Notification System -->
  <script src="{{ url_for('static', filename='js/toast.js') }}"></script>

  <script>
    // Global variables
    let currentProvince = "{{ selected_province }}";
    let currentForecastDays = Number("{{ selected_forecast_days or 1 }}");
    let currentSelectedDistrict = null;
    let currentBasemap = "Mapbox Satellite";
    let isBlinkingActive = true;

    // Function to be called from map iframe when basemap changes
    function updateActiveBasemap(name) {
      console.log("Basemap changed to:", name);
      currentBasemap = name;
    }

    // Show loading overlay
    function showLoading(text = "Loading...") {
      document.getElementById('loadingText').textContent = text;
      document.getElementById('loadingOverlay').style.display = 'flex';
    }

    // Hide loading overlay
    function hideLoading() {
      document.getElementById('loadingOverlay').style.display = 'none';
    }

    // Show notification using toast system (REPLACED alert())
    function showNotification(message, type = 'success') {
      console.log(`${type}: ${message}`);
      toast.show(message, type);
    }

    // Get selected districts
    function getSelectedDistricts() {
      const checkboxes = document.querySelectorAll('#districtFilter input[type="checkbox"]:checked');
      return Array.from(checkboxes).map(cb => cb.value);
    }

    // Update districts list when province changes
    async function updateDistrictsForProvince(province) {
      showLoading('Loading districts...');

      try {
        const response = await fetch(`/get_districts/${province}`);
        const data = await response.json();

        const districtFilter = document.getElementById('districtFilter');
        districtFilter.innerHTML = '';

        data.districts.forEach((district, index) => {
          const div = document.createElement('div');
          div.className = 'form-check d-flex align-items-center gap-2 mb-2';

          const input = document.createElement('input');
          input.className = 'neo-checkbox';
          input.type = 'checkbox';
          input.name = 'districts';
          input.value = district;
          input.id = `district-${index + 1}`;
          input.checked = true;

          const label = document.createElement('label');
          label.className = 'form-check-label';
          label.htmlFor = `district-${index + 1}`;
          label.textContent = district;
          label.style.cursor = 'pointer';

          // Add click event to load district alert when label is clicked
          label.addEventListener('click', () => {
            loadDistrictAlert(province, district);
          });

          div.appendChild(input);
          div.appendChild(label);
          districtFilter.appendChild(div);
        });

        currentProvince = province;
        document.getElementById('currentProvince').textContent = province;

      } catch (error) {
        console.error('Error loading districts:', error);
        showNotification('Failed to load districts', 'error');
      } finally {
        hideLoading();
      }
    }

    // Toggle blinking animation
    function toggleAnimation() {
      isBlinkingActive = !isBlinkingActive;
      const btn = document.getElementById('blinkingToggle');
      const icon = btn.querySelector('i');
      const span = btn.querySelector('span');

      if (isBlinkingActive) {
        icon.className = 'fas fa-eye';
        span.textContent = 'Disable Animation';
        btn.classList.remove('btn-danger-sidebar');
      } else {
        icon.className = 'fas fa-eye-slash';
        span.textContent = 'Enable Animation';
        btn.classList.add('btn-danger-sidebar');
      }

      // Try to update map iframe instantly
      try {
        const mapIframe = document.querySelector('.map-content iframe');
        if (mapIframe && mapIframe.contentWindow && mapIframe.contentWindow.toggleBlinking) {
          mapIframe.contentWindow.toggleBlinking(isBlinkingActive);
        }
      } catch (e) {
        console.warn("Could not toggle blinking instantly:", e);
      }
    }

    // Refresh map with persistence
    async function refreshMap() {
      const forecastDays = document.getElementById('forecast_days').value;
      const districts = getSelectedDistricts();

      showLoading('Refreshing map...');

      try {
        const url = `/refresh_map/${forecastDays}?basemap=${encodeURIComponent(currentBasemap)}&districts=${districts.join(',')}&blinking=${isBlinkingActive}`;
        const response = await fetch(url);
        const result = await response.json();

        if (result.map_html) {
          document.querySelector('.map-content').innerHTML = result.map_html;
        }
      } catch (error) {
        console.error('Error refreshing map:', error);
      } finally {
        hideLoading();
      }
    }

    // Refresh map when forecast days change
    async function refreshMapOnDaysChange() {
      const forecastDays = document.getElementById('forecast_days').value;
      const districts = getSelectedDistricts();

      showLoading('Updating map...');

      try {
        const url = `/refresh_map/${forecastDays}?basemap=${encodeURIComponent(currentBasemap)}&districts=${districts.join(',')}&blinking=${isBlinkingActive}`;
        const response = await fetch(url);
        const result = await response.json();

        if (result.map_html) {
          document.querySelector('.map-content').innerHTML = result.map_html;
        }
      } catch (error) {
        console.error('Error updating map:', error);
      } finally {
        hideLoading();
      }
    }

    // Load and display alert for a specific district
    async function loadDistrictAlert(province, district) {
      const forecastDays = document.getElementById('forecast_days').value;

      showLoading(`Loading alert for ${district}...`);

      try {
        const response = await fetch(`/get_alert/${province}/${district}/${forecastDays}`);
        const result = await response.json();

        if (result.status === 'success') {
          // Update the alert header to show current district
          document.getElementById('currentProvince').textContent = `${province} - ${district}`;

          // Format and display the alert
          const alertContent = document.getElementById('alertContent');
          const formattedHtml = formatSingleDistrictAlert(district, result.alert);
          alertContent.innerHTML = formattedHtml;

          // Apply typing animation to the alert message
          const alertMsgElement = alertContent.querySelector('.typing-alert-message');
          if (alertMsgElement) {
            const fullText = alertMsgElement.innerHTML;
            alertMsgElement.innerHTML = '';
            new Typed(alertMsgElement, {
              strings: [fullText],
              typeSpeed: 15,
              showCursor: false,
              loop: false,
              contentType: 'html'
            });
          }

          // Highlight the selected district
          currentSelectedDistrict = district;
          highlightSelectedDistrict(district);

        } else {
          document.getElementById('alertContent').innerHTML =
            `<div class="no-alerts">${result.alert}</div>`;
        }
      } catch (error) {
        console.error('Error loading district alert:', error);
        document.getElementById('alertContent').innerHTML =
          '<div class="no-alerts">Error loading alert. Please try again.</div>';
      } finally {
        hideLoading();
      }
    }

    // Format alert for a single district
    function formatSingleDistrictAlert(district, alertText) {
      if (!alertText) {
        return `<div class="no-alerts">No alert available for ${district}.</div>`;
      }

      let html = `
              <div class="selected-district-header">
                  <h6><i class="fas fa-map-marker-alt"></i> ${district}</h6>
                  <small class="text-muted">Click on other districts in the map or list to view their alerts</small>
              </div>
              <hr>
              <div class="district-alert-content">
                  <div class="alert-message typing-alert-message">
          `;

      // Clean up the alert text
      let cleanAlert = alertText;

      // Remove the district name pattern if present
      const districtPattern = new RegExp(`\\*\\*${district}\\s+Weather Alert\\*\\*\\s*:?\\s*`, 'i');
      cleanAlert = cleanAlert.replace(districtPattern, '');

      // Remove any remaining ** markers
      cleanAlert = cleanAlert.replace(/\*\*/g, '');

      html += cleanAlert;
      html += `</div></div>`;
      return html;
    }

    // Highlight the selected district in the filter list
    function highlightSelectedDistrict(district) {
      // Remove previous highlights
      const allLabels = document.querySelectorAll('#districtFilter .form-check-label');
      allLabels.forEach(label => {
        label.classList.remove('selected-district');
        label.style.fontWeight = 'normal';
        label.style.backgroundColor = 'transparent';
      });

      // Highlight current district
      const districtCheckboxes = document.querySelectorAll('#districtFilter input[type="checkbox"]');
      districtCheckboxes.forEach(checkbox => {
        if (checkbox.value === district) {
          const label = checkbox.nextElementSibling;
          if (label) {
            label.classList.add('selected-district');
            label.style.fontWeight = 'bold';
            label.style.backgroundColor = 'rgba(44, 90, 160, 0.2)';
            label.style.padding = '2px 5px';
            label.style.borderRadius = '3px';
          }
        }
      });
    }

    // Generate forecast via AJAX
    async function generateForecast() {
      const province = document.getElementById('province').value;
      const forecastDays = document.getElementById('forecast_days').value;
      const districts = getSelectedDistricts();

      showLoading(`Generating ${forecastDays} day(s) forecast...`);

      try {
        const response = await fetch('/generate_forecast', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            province: province,
            districts: districts,
            forecast_days: parseInt(forecastDays)
          })
        });

        const result = await response.json();

        if (result.status === 'success') {
          showNotification(result.message, 'success');
        } else {
          showNotification(result.message, 'error');
        }
      } catch (error) {
        console.error('Error generating forecast:', error);
        showNotification('Failed to generate forecast', 'error');
      } finally {
        hideLoading();
      }
    }

    // Purge cache via AJAX
    async function purgeCache() {
      const province = document.getElementById('province').value;
      const forecastDays = document.getElementById('forecast_days').value;
      const districts = getSelectedDistricts();

      const confirmMsg = districts.length > 0
        ? `Are you sure you want to purge cache for ${districts.length} selected district(s)?`
        : `Are you sure you want to purge cache for ALL districts in ${province}?`;

      if (!confirm(confirmMsg + '\nThis will require fetching fresh data from the API.')) {
        return;
      }

      showLoading('Purging cache...');

      try {
        const response = await fetch('/purge_cache', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            province: province,
            districts: districts,
            forecast_days: parseInt(forecastDays)
          })
        });

        const result = await response.json();

        if (result.status === 'success') {
          showNotification(result.message, 'success');
        } else {
          showNotification(result.message, 'error');
        }
      } catch (error) {
        console.error('Error purging cache:', error);
        showNotification('Failed to purge cache', 'error');
      } finally {
        hideLoading();
      }
    }

    // Generate alerts via AJAX
    async function generateAlerts() {
      const province = document.getElementById('province').value;
      const forecastDays = document.getElementById('forecast_days').value;

      showLoading(`Generating alerts for ${forecastDays} day(s)...`);

      try {
        const response = await fetch('/generate_alerts', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            province: province,
            forecast_days: parseInt(forecastDays)
          })
        });

        const result = await response.json();

        if (result.status === 'success') {
          showNotification(result.message);
          // Show all alerts initially
          document.getElementById('alertContent').innerHTML = formatAlertText(result.alert_text);
          await refreshMap();
        } else {
          showNotification(result.message, 'error');
        }
      } catch (error) {
        console.error('Error generating alerts:', error);
        showNotification('Failed to generate alerts: ' + error.message, 'error');
      } finally {
        hideLoading();
      }
    }

    // Refresh map after generating forecasts or alerts
    async function refreshMap() {
      const forecastDays = document.getElementById('forecast_days').value;
      const districts = getSelectedDistricts();

      showLoading('Refreshing map...');

      try {
        const response = await fetch(`/refresh_map/${forecastDays}?basemap=${encodeURIComponent(currentBasemap)}&districts=${encodeURIComponent(districts.join(','))}`);
        const result = await response.json();

        if (result.map_html) {
          const mapContainer = document.querySelector('.map-content');
          mapContainer.innerHTML = result.map_html;
        }
      } catch (error) {
        console.error('Error refreshing map:', error);
      } finally {
        hideLoading();
      }
    }

    function formatAlertText(alertText) {
      if (!alertText) return '<div class="no-alerts">No alerts generated.</div>';

      let html = `
            <div class="selected-district-header">
                <h6><i class="fas fa-list"></i> All District Alerts</h6>
                <small class="text-muted">Click on any district in the map or list to view individual alerts</small>
            </div>
            <hr>
        `;

      // Parse text to group by district
      const districtAlerts = {};
      let regionSummary = "";

      // Regex to find "**District**: Alert" blocks
      const districtRegex = /\*\*([^*]+?)\*\*:\s*([\s\S]*?)(?=\*\*|\n\s*Region's Summary|$)/g;
      let match;

      while ((match = districtRegex.exec(alertText)) !== null) {
        const fullTitle = match[1].trim();
        const alertMsg = match[2].trim();

        // Extract district name from "District Weather Alert"
        const district = fullTitle.replace(/\s+Weather Alert$/, '');

        if (districtAlerts[district]) {
          districtAlerts[district] += " " + alertMsg;
        } else {
          districtAlerts[district] = alertMsg;
        }
      }

      // Extract Region's Summary
      const summaryMatch = alertText.match(/Region's Summary:\s*([\s\S]*)$/);
      if (summaryMatch) {
        regionSummary = summaryMatch[1].trim();
      }

      // Render District Alerts
      for (const [district, msg] of Object.entries(districtAlerts)) {
        html += `
          <div class="district-alert-box">
            <div class="district-alert-header">
              <i class="fas fa-map-marker-alt"></i> ${district}
            </div>
            <div class="all-alerts-message">
              ${msg}
            </div>
          </div>
        `;
      }

      // Render Region Summary
      if (regionSummary) {
        html += `
          <div class="province-summary-header">
            <div class="summary-title">
              <i class="fas fa-info-circle"></i> Region's Summary
            </div>
            <div class="all-alerts-message">${regionSummary}</div>
          </div>
        `;
      }

      // Fallback if regex fails (e.g. raw text display)
      if (Object.keys(districtAlerts).length === 0 && !regionSummary) {
        html += `<div class="all-alerts-message">${alertText.replace(/\n/g, '<br>')}</div>`;
      }

      return html;
    }

    // Function to load all alerts
    async function loadAllAlerts() {
      const days = document.getElementById('forecast_days').value;

      try {
        const response = await fetch(`/get_all_alerts/${days}`);
        const data = await response.json();
        console.log('Alerts loaded successfully');
      } catch (error) {
        console.error('Error loading alerts:', error);
      }
    }

    // Filter districts based on search term
    function filterDistricts(searchTerm) {
      const checkboxes = document.querySelectorAll('#districtFilter .form-check');
      const term = searchTerm.toLowerCase().trim();

      let visibleCount = 0;
      checkboxes.forEach(checkbox => {
        const label = checkbox.querySelector('label').textContent.toLowerCase();
        const isVisible = label.includes(term);
        checkbox.style.display = isVisible ? 'block' : 'none';
        if (isVisible) visibleCount++;
      });

      // Show message if no results
      const existingMsg = document.getElementById('no-results-msg');
      if (existingMsg) existingMsg.remove();

      if (visibleCount === 0 && term) {
        const msg = document.createElement('div');
        msg.id = 'no-results-msg';
        msg.className = 'text-muted text-center py-2';
        msg.textContent = 'No districts found';
        document.getElementById('districtFilter').appendChild(msg);
      }
    }

    function selectAllDistricts() {
      const checkboxes = document.querySelectorAll('#districtFilter input[type="checkbox"]');
      checkboxes.forEach(checkbox => {
        if (checkbox.parentElement.style.display !== 'none') {
          checkbox.checked = true;
        }
      });
    }

    function deselectAllDistricts() {
      const checkboxes = document.querySelectorAll('#districtFilter input[type="checkbox"]');
      checkboxes.forEach(checkbox => {
        if (checkbox.parentElement.style.display !== 'none') {
          checkbox.checked = false;
        }
      });
    }

    // Keyboard shortcuts for accessibility
    document.addEventListener('keydown', (e) => {
      // Ctrl+G or Ctrl+A: Run Full Analysis
      if ((e.ctrlKey && e.key === 'g') || (e.ctrlKey && e.key === 'a' && e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA')) {
        e.preventDefault();
        generateForecastAndAlerts();
      }
      // Escape: Clear search
      if (e.key === 'Escape') {
        const searchInput = document.getElementById('districtSearch');
        if (searchInput && searchInput.value) {
          searchInput.value = '';
          filterDistricts('');
          searchInput.focus();
        }
      }
    });

    // Generate both forecasts and alerts
    async function generateForecastAndAlerts() {
      const province = document.getElementById('province').value;
      const forecastDays = document.getElementById('forecast_days').value;
      const districts = getSelectedDistricts();

      if (districts.length === 0) {
        toast.warning('Please select at least one district.');
        return;
      }

      showLoading(`Generating forecasts and alerts for ${forecastDays} day(s)...`);

      try {
        const response = await fetch('/generate_forecast_and_alerts', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            province: province,
            districts: districts,
            forecast_days: parseInt(forecastDays)
          })
        });

        const result = await response.json();

        if (result.status === 'success') {
          showNotification(result.message);
          const alertContent = document.getElementById('alertContent');
          alertContent.innerHTML = formatAlertText(result.alert_text);

          // Typing animation for full alerts - summarize into a single string for better visual
          const allMessages = Array.from(alertContent.querySelectorAll('.all-alerts-message'));
          allMessages.forEach(el => {
            const fullText = el.innerHTML;
            el.innerHTML = '';
            new Typed(el, {
              strings: [fullText],
              typeSpeed: 10,
              showCursor: false,
              loop: false,
              contentType: 'html'
            });
          });

          await refreshMap();
        } else {
          showNotification(result.message, 'error');
        }
      } catch (error) {
        console.error('Error generating forecasts and alerts:', error);
        showNotification('Failed to generate forecasts and alerts: ' + error.message, 'error');
      } finally {
        hideLoading();
      }
    }



    // Update province when changed
    document.getElementById('province').addEventListener('change', function () {
      const selectedProvince = this.value;
      updateDistrictsForProvince(selectedProvince);
      currentSelectedDistrict = null; // Reset selected district
    });

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function () {
      // Initialize Bootstrap tooltips
      const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
      tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl, {
          delay: { show: 500, hide: 100 }
        });
      });

      // Auto-load alerts on page load (UX improvement)
      console.log('Page loaded, auto-loading alerts...');
      setTimeout(() => {
        loadAllAlerts();
        toast.info('Welcome! Alerts loaded automatically.', 3000);
      }, 1000);
    });
  </script>
</body>

</html>